#!/bin/sh

# shellcheck source=../../client/scripts/utilities/bin/management
. "$SNAP/bin/management"

handle_config() {
    # Check required config is set
    if ! has_config_set; then
        return $?
    fi

    config="$(printf 'issuer: %s\nclient_id: %s\nscopes: [%s]\nredirect_url: %s\nca_url: %s\n' \
        "$(issuer)" "$(clien-id)" "$(scopes)" "$(redirect-url)" "$(ca-url)")"

    if ca="$(trusted-ca)"; then
        config="$(printf '%s\ntrusted_ca: %s\n' "$config" "$ca")"
    fi

    if ! tempconfig="$(mktemp "$SNAP_DATA/config.yml.XXXXXXXX")"; then
        return $?
    fi

    if ! echo "$config" > "$tempconfig"; then
        return $?
    fi

    if ! chmod 0644 "$tempconfig"; then
        return $?
    fi

    mv -f "$tempconfig" "$SNAP_DATA/config.yml"
}

handle_config
